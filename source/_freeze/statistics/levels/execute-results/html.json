{
  "hash": "3f489a4e47cdbdc0e4595a27341fcdd8",
  "result": {
    "markdown": "---\ntitle: Required number of levels for a random effects\nauthor: Thierry Onkelinx\ndate: 2018-09-03\ncategories: [statistics, mixed-models]\nimage: levels_files/figure-html/unnamed-chunk-7-1.svg\nknitr: \n  opts_chunk: \n    echo: false\n    fig.width: 6\n    dev: svg\n---\n\n\nWhen we analyse a mixed models, the question often arises whether a covariate should be used as a random effect or as a fixed effects. Let's assume a simple design. Two types of fertilizer are tested on a number of fields ($n_s$). Each field is split in two and the fertilizers are assigned at random to these halves while making sure that each field has both treatments. From a conceptual point of view, we are only interested in the effect of the fertilizers. However, we need to take the potential effect of the field into account. Hence we use `fertiliser` as a fixed effect and `field` as a random effect.\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Example design\n\n| field|Part 1 |Part2 |\n|-----:|:------|:-----|\n|     1|A      |B     |\n|     2|A      |B     |\n|     3|A      |B     |\n|     4|B      |A     |\n|     5|B      |A     |\n|     6|B      |A     |\n|     7|B      |A     |\n|     8|A      |B     |\n|     9|A      |B     |\n|    10|B      |A     |\n:::\n:::\n\n\nWhile this makes conceptually sense,\nwe might run into computational problems.\nInstead of estimating each individual field effect, we want to estimate the variability due to field effect.\nThis is the variance of the random effect, rather than the estimates for the individual random effect levels.\nBut how precise is the estimate of this random effect variance?\nThe sample variance $s^2$ follows a [scaled $\\chi^2$ distribution](https://en.wikipedia.org/wiki/Variance#Distribution_of_the_sample_variance).\n\n$$(n_s - 1)\\frac{s^2}{\\sigma^2} \\sim \\chi^2_{n_s-1}$$\n\nThis equation makes it straightforward to calculate the distribution of the $r = \\sigma^2/s^2$ ratio for a given $n_s$.\nWe can rewrite this as $\\sigma^2=rs^2$ or the true variance is a multiple $r$ of the estimated variance $s^2$.\nThe distribution of $r$ is derived below.\n\n$$(n_s - 1)\\frac{s^2}{\\sigma^2} \\sim \\chi^2_{n_s-1}$$\n\n$$\\frac{s^2}{\\sigma^2} \\sim \\frac{\\chi^2_{n_s-1}}{(n_s - 1)}$$\n\n$$r = \\frac{\\sigma^2}{s^2} \\sim \\frac{(n_s - 1)}{\\chi^2_{n_s-1}}$$\n\n\n::: {.cell}\n\n:::\n\n\nEven when with a large number of levels ($n_s = 1000$), there still is a reasonable amount of uncertainty around $\\sigma^2$ since the 95% interval of $r$ ranges from 0.918 to 1.094.\nThe full distribution for $r$ when $n_s = 1000$ is shown in the figure below.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Distribution of the relative true variance ($\\frac{\\sigma^2}{s^2}$) when $n_s = 1000$. Dashed line: $\\frac{\\sigma^2}{s^2} = 1$ Dotted lines: 2.5% and 97.5% quantiles of $\\frac{\\sigma^2}{s^2}$. Dash-dotted line: median of $\\frac{\\sigma^2}{s^2}$.](levels_files/figure-html/fig-rel-var-1000-1.svg){#fig-rel-var-1000 width=576}\n:::\n:::\n\n\nA thousand random effect levels is not always feasible.\nSo what will happen if we use a more realistic number of random effect levels, e.g. $n_s = 20$.\nThe distribution of $r$ will be wider as $n_s$ decreases.\nAt $n_s = 20$, the 95% interval of $r$ will range from 0.578 to 2.133.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Distribution of the relative true variance ($\\frac{\\sigma^2}{s^2}$) when $n_s = 20$. Dashed line: $\\frac{\\sigma^2}{s^2} = 1$ Dotted lines: 2.5% and 97.5% quantiles of $\\frac{\\sigma^2}{s^2}$. Dash-dotted line: median of $\\frac{\\sigma^2}{s^2}$.](levels_files/figure-html/fig-rel-var-20-1.svg){#fig-rel-var-20 width=576}\n:::\n:::\n\n\nHow low can we go? The figure below depicts the density of $r$ when $n_s = 4$.\nThe 95% interval of $r$ ranges from 0.321 to 13.902, so we can hardly do any inference on the estimated variance.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Distribution of the relative true variance ($\\frac{\\sigma^2}{s^2}$) when $n_s = 4$. Dashed line: $\\frac{\\sigma^2}{s^2} = 1$ Dotted lines: 2.5% and 97.5% quantiles of $\\frac{\\sigma^2}{s^2}$. Dash-dotted line: median of $\\frac{\\sigma^2}{s^2}$.](levels_files/figure-html/fig-rel-var-4-1.svg){#fig-rel-var-4 width=576}\n:::\n:::\n\n\n## Recommendations\n\nWe see that the number of random effect levels has a strong impact on the uncertainty of the estimate variance.\nThe figure below displays the 97.5% quantile of $r$ for a large range of $n_s$ values.\nSince the right tail of $r$ is heavier than the left tail, it is a good idea to focus on the 97.5% quantile.\nBased on this figure we can give the following recommendations:\n\n- get $n_s > 1000$ levels when an accurate estimate of the random effect variance is crucial.\n  E.g. when a single number will be use for power calculations.\n- get $n_s > 100$ levels when a reasonable estimate of the random effect variance is sufficient.\n  E.g. power calculations with sensitivity analysis of the random effect variance.\n- get $n_s > 20$ levels for an experimental study\n- in case $10 < n_s < 20$ you should validate the model very cautious before using the output\n- in case $n_s < 10$ it is safer to use the variable as a fixed effect.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Uncertainty on the random effect variance in function of the number of random effect levels.](levels_files/figure-html/fig-recommendation-1.svg){#fig-recommendation width=576}\n:::\n:::\n\n\n## Session info\n\nThese R packages were used to create this post.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n─ Session info ───────────────────────────────────────────────────────────────\n setting  value\n version  R version 4.3.1 (2023-06-16)\n os       Ubuntu 22.04.3 LTS\n system   x86_64, linux-gnu\n ui       X11\n language nl_BE:nl\n collate  nl_BE.UTF-8\n ctype    nl_BE.UTF-8\n tz       Europe/Brussels\n date     2023-09-02\n pandoc   3.1.1 @ /usr/lib/rstudio/resources/app/bin/quarto/bin/tools/ (via rmarkdown)\n\n─ Packages ───────────────────────────────────────────────────────────────────\n package     * version    date (UTC) lib source\n cli           3.6.1      2023-03-23 [1] CRAN (R 4.3.0)\n colorspace    2.1-0      2023-01-23 [1] CRAN (R 4.3.0)\n digest        0.6.32     2023-06-26 [1] CRAN (R 4.3.1)\n dplyr       * 1.1.2      2023-04-20 [1] CRAN (R 4.3.0)\n evaluate      0.21       2023-05-05 [1] CRAN (R 4.3.0)\n fansi         1.0.4      2023-01-22 [1] CRAN (R 4.3.0)\n farver        2.1.1      2022-07-06 [1] CRAN (R 4.3.0)\n fastmap       1.1.1      2023-02-24 [1] CRAN (R 4.3.0)\n forcats     * 1.0.0      2023-01-29 [1] CRAN (R 4.3.0)\n generics      0.1.3      2022-07-05 [1] CRAN (R 4.3.0)\n ggplot2     * 3.4.2      2023-04-03 [1] CRAN (R 4.3.0)\n glue          1.6.2      2022-02-24 [1] CRAN (R 4.3.0)\n gtable        0.3.3      2023-03-21 [1] CRAN (R 4.3.0)\n hms           1.1.3      2023-03-21 [1] CRAN (R 4.3.0)\n htmltools     0.5.5      2023-03-23 [1] CRAN (R 4.3.0)\n htmlwidgets   1.6.2      2023-03-17 [1] CRAN (R 4.3.0)\n jsonlite      1.8.7      2023-06-29 [1] CRAN (R 4.3.1)\n knitr       * 1.43       2023-05-25 [1] CRAN (R 4.3.0)\n labeling      0.4.2      2020-10-20 [1] CRAN (R 4.3.0)\n lifecycle     1.0.3      2022-10-07 [1] CRAN (R 4.3.0)\n lubridate   * 1.9.2.9000 2023-05-15 [1] https://inbo.r-universe.dev (R 4.3.0)\n magrittr      2.0.3      2022-03-30 [1] CRAN (R 4.3.0)\n munsell       0.5.0      2018-06-12 [1] CRAN (R 4.3.0)\n pillar        1.9.0      2023-03-22 [1] CRAN (R 4.3.0)\n pkgconfig     2.0.3      2019-09-22 [1] CRAN (R 4.3.0)\n purrr       * 1.0.1      2023-01-10 [1] CRAN (R 4.3.0)\n R6            2.5.1      2021-08-19 [1] CRAN (R 4.3.0)\n readr       * 2.1.4      2023-02-10 [1] CRAN (R 4.3.0)\n rlang         1.1.1      2023-04-28 [1] CRAN (R 4.3.0)\n rmarkdown     2.23       2023-07-01 [1] CRAN (R 4.3.1)\n rstudioapi    0.14       2022-08-22 [1] CRAN (R 4.3.0)\n scales        1.2.1      2022-08-20 [1] CRAN (R 4.3.0)\n sessioninfo   1.2.2      2021-12-06 [1] CRAN (R 4.3.0)\n stringi       1.7.12     2023-01-11 [1] CRAN (R 4.3.0)\n stringr     * 1.5.0      2022-12-02 [1] CRAN (R 4.3.0)\n tibble      * 3.2.1      2023-03-20 [1] CRAN (R 4.3.0)\n tidyr       * 1.3.0      2023-01-24 [1] CRAN (R 4.3.0)\n tidyselect    1.2.0      2022-10-10 [1] CRAN (R 4.3.0)\n tidyverse   * 2.0.0      2023-02-22 [1] CRAN (R 4.3.0)\n timechange    0.2.0      2023-01-11 [1] CRAN (R 4.3.0)\n tzdb          0.4.0      2023-05-12 [1] CRAN (R 4.3.0)\n utf8          1.2.3      2023-01-31 [1] CRAN (R 4.3.0)\n vctrs         0.6.3      2023-06-14 [1] CRAN (R 4.3.0)\n withr         2.5.0      2022-03-03 [1] CRAN (R 4.3.0)\n xfun          0.39       2023-04-20 [1] CRAN (R 4.3.0)\n yaml          2.3.7      2023-01-23 [1] CRAN (R 4.3.0)\n\n [1] /home/thierry/R/x86_64-pc-linux-gnu-library/4.3\n [2] /usr/local/lib/R/site-library\n [3] /usr/lib/R/site-library\n [4] /usr/lib/R/library\n\n──────────────────────────────────────────────────────────────────────────────\n```\n:::\n:::\n",
    "supporting": [
      "levels_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}